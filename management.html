<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
        integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
        integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            background-color: #f8f9fa;
        }

        main {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }

        .card {
            margin-bottom: 1.5rem;
        }

        .form-scroll {
            max-height: 450px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .table-hover tbody tr:hover {
            background-color: #f1f1f1;
            cursor: pointer;
        }
    </style>

</head>

<body>
    <header class="mb-4">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
            <div class="container">
                <a class="navbar-brand" href="/introduction">
                    <span style="color: red; font-weight: bold;">APIX</span> ENGLISH
                </a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item active"><a class="nav-link" href="management.html">Student <span
                                    class="sr-only">(current)</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="teacher-manager.html">Teacher</a></li>
                        <li class="nav-item"><a class="nav-link" href="book-manager.html">Book</a></li>
                        <li class="nav-item"><a class="nav-link" href="class-manager.html">Class</a></li>
                        <li class="nav-item"><a class="nav-link" href="account-manager.html">Account</a></li>
                        <li class="nav-item"><a class="nav-link" href="image-manager.html">Images</a></li>
                        <li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>
    <main>
        <div class="container">
            <div class="row">
                <!-- Student List Column -->
                <div class="col-md-8">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Student List</h5>
                            <button type="button" class="btn btn-danger add-student-button"><i class="fa fa-plus"></i>
                                Add New Student</button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th scope="col">#</th>
                                            <th scope="col">Last Name</th>
                                            <th scope="col">First Name</th>
                                            <th scope="col">Telephone</th>
                                            <th scope="col">Study Date</th>
                                            <th scope="col">Class</th>
                                            <th scope="col">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Student data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center mt-4" id="pagination"></ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Forms and Details Column -->
                <div class="col-md-4">
                    <div id="sidebar-cards">
                        <!-- Search & Filter Card -->
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fa fa-filter"></i> Filters & Search</h5>
                            </div>
                            <div class="card-body">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" id="search-input"
                                        placeholder="Search by Name, Phone...">
                                </div>
                                <div class="form-group mb-2">
                                    <select id="class-filter" class="form-control">
                                        <option value="">-- Filter by Class --</option>
                                        <!-- Class options will be loaded here -->
                                    </select>
                                </div>
                                <div class="d-flex">
                                    <button class="btn btn-primary search flex-grow-1" type="button"><i
                                            class="fa fa-search"></i> Search</button>
                                    <button class="btn btn-secondary ml-2" id="reset-search-btn"
                                        type="button">Reset</button>
                                </div>
                            </div>
                        </div>

                        <!-- Student Details Card -->
                        <div class="card shadow-sm detail2">
                            <div class="card-header">
                                <h5 class="mb-0">Student Details</h5>
                            </div>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">Select a student to see details.</li>
                            </ul>
                            <div class="card-footer" style="display: none;">
                                <button class="btn btn-info w-100" id="edit-student-btn">Edit Student</button>
                            </div>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addStudentModalLabel">Add New Student</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form action="/addStudent" method="post">
                    <div class="modal-body">
                        <div class="form-group mb-2"><input type="text" class="form-control" name="lastname"
                                placeholder="Last Name" required></div>
                        <div class="form-group mb-2"><input type="text" class="form-control" name="firstname"
                                placeholder="First Name" required></div>
                        <div class="form-group mb-2"><input type="tel" class="form-control" name="tele"
                                placeholder="Telephone"></div>
                        <div class="form-group mb-2"><label>Enrollment Date</label><input type="date"
                                class="form-control" name="datestudy"></div>
                        <div class="form-group mb-2">
                            <label>Class</label>
                            <select name="class" class="form-control add-class-select"></select>
                        </div>
                        <div class="form-group mb-2"><input type="text" class="form-control" name="teacher"
                                placeholder="Main Teacher"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Student</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editStudentModalLabel">Edit Student Information</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="update-student-form">
                    <div class="modal-body">
                        <input type="hidden" name="id" id="update-id">
                        <div class="form-group mb-2"><label>Last Name</label><input type="text" class="form-control"
                                name="lastname" id="update-lastname"></div>
                        <div class="form-group mb-2"><label>First Name</label><input type="text" class="form-control"
                                name="firstname" id="update-firstname"></div>
                        <div class="form-group mb-2"><label>Telephone</label><input type="tel" class="form-control"
                                name="tele" id="update-tele"></div>
                        <div class="form-group mb-2"><label>Study Date</label><input type="date" class="form-control"
                                name="datestudy" id="update-datestudy"></div>
                        <div class="form-group mb-2">
                            <label>Class</label>
                            <select name="class" id="update-class" class="form-control"></select>
                        </div>
                        <div class="form-group mb-2"><label>Teacher</label><input type="text" class="form-control"
                                name="teacher" id="update-teacher"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript">

        $(document).ready(function () {
            let all_students = [];
            let all_classes_data = []; // Store full class data

            // Helper to format date for input fields
            const toInputDate = (dateString) => dateString ? dateString.split('T')[0] : '';

            // Show the "Add Student" form
            $(".add-student-button").click(function () {
                $('#addStudentModal').modal('show');
            });

            // Generic cancel button
            $(".cancel-action-btn").click(function () {
                $(this).closest('.card').hide(); // This is for the old card, can be removed if not used elsewhere
                $('#sidebar-cards > .card:not(.add):not(.change)').show();
            });


            // Load all classes into filter and forms
            function loadClassesIntoSelect() {
                $.get('/classdata', function (classes) {
                    all_classes_data = classes; // Save class data globally

                    const classFilter = $('#class-filter');
                    const updateClassSelect = $('#update-class');
                    const addClassSelect = $('.add-class-select');

                    classFilter.find('option:not(:first)').remove();
                    updateClassSelect.empty();
                    addClassSelect.empty().append('<option value="">-- Select a Class --</option>');

                    classes.forEach(cls => {
                        addClassSelect.append(`<option value="${cls.class_code}">${cls.class_name} (${cls.class_code})</option>`);
                        classFilter.append(`<option value="${cls.class_code}">${cls.class_name} (${cls.class_code})</option>`);
                        updateClassSelect.append(`<option value="${cls.class_code}">${cls.class_name} (${cls.class_code})</option>`);
                    });
                }, 'json');
            }

            // Auto-fill teacher name when a class is selected in the Add modal
            $('#addStudentModal').on('change', '.add-class-select', function () {
                const selectedClassCode = $(this).val();
                const teacherInput = $('#addStudentModal').find('input[name="teacher"]');

                if (selectedClassCode) {
                    const selectedClass = all_classes_data.find(cls => cls.class_code === selectedClassCode);
                    if (selectedClass && selectedClass.teacher) {
                        teacherInput.val(selectedClass.teacher);
                    } else {
                        teacherInput.val(''); // Clear if class has no teacher
                    }
                } else {
                    teacherInput.val(''); // Clear if no class is selected
                }
            });
            // Initial data load
            loadPage();
            loadClassesIntoSelect();

            // Fetch all students for client-side searching/filtering
            function loadAllStudents() {
                $.get("/getallstudentdata", function (data) {
                    all_students = data;
                    loadPage(); // Reload the first page with all students
                }, 'json');
            }
            loadAllStudents();

            // Handle Delete
            $("tbody").on('click', '.delete', function () {
                let id = $(this).closest('tr').attr("class");
                $.post('/removestudent', { id: id }, function (data) {
                    alert(data.message);
                    loadAllStudents(); // Reload all data
                });
            })
            $("tbody").on('click', '.Delete', function () {
                updateTable();
            })

            // When a table row is clicked (but not the delete button)
            $("tbody").on('click', 'tr', function () {
                $('.detail2 .list-group').html('<li class="list-group-item">Loading...</li>');
                $('.detail2 .card-footer').hide();
                $('.detail2').fadeIn();

                const id = $(this).attr("class");
                let student;
                for (let i of all_students) {
                    if (i.id == id) {
                        student = i;
                    }
                }
                let base = ` <li class="list-group-item"><b>IDENTITY:</b> ${student.id}</li>
                            <li class="list-group-item"><b>FULL NAME:</b> ${student.LastName} ${student.FirstName} </li>
                            <li class="list-group-item"><b>PHONE:</b> ${student.tel}</li>
                            <li class="list-group-item"><b>STUDY ON: </b>${student.dateStudy.slice(0, 10)}</li>
                            <li class="list-group-item"><b>CLASS: </b>${student.class}</li>
                            <li class="list-group-item"><b>TEACHER: </b>${student.teacher}</li>
                            `
                $('.detail2 .list-group').html(base); // Populate details
                $('.detail2 .card-footer').show(); // Show the footer with the Edit button

                // Populate and show the update form
                $('#update-id').val(student.id);
                $('#update-lastname').val(student.LastName);
                $('#update-firstname').val(student.FirstName);
                $('#update-tele').val(student.tel);
                $('#update-datestudy').val(toInputDate(student.dateStudy));
                $('#update-class').val(student.class);
                $('#update-teacher').val(student.teacher);
            });

            // Handle clicking the "Edit Student" button on the details card
            $('#edit-student-btn').on('click', function () {
                $('#editStudentModal').modal('show');
            });

            // Handle Search and Filter
            $(".search").click(function () {
                const searchTerm = $('#search-input').val().toLowerCase();
                const classFilter = $('#class-filter').val();

                const filteredStudents = all_students.filter(student => {
                    const nameMatch = `${student.LastName} ${student.FirstName}`.toLowerCase().includes(searchTerm);
                    const phoneMatch = student.tel && student.tel.includes(searchTerm);
                    const classMatch = !classFilter || student.class === classFilter;

                    return (nameMatch || phoneMatch) && classMatch;
                });

                // Since we don't have server-side pagination for filtered results,
                // we will display all filtered results at once.
                displayStudentsInTable(filteredStudents);
                $('#pagination').empty(); // Hide pagination for filtered results
            });

            // Reset search
            $('#reset-search-btn').click(function () {
                $('#search-input').val('');
                $('#class-filter').val('');
                loadPage(); // Reload paginated data
            });

            // Handle Update Form Submission
            $('#update-student-form').submit(function (e) {
                e.preventDefault();
                const studentData = {
                    id: $('#update-id').val(),
                    lastname: $('#update-lastname').val(),
                    firstname: $('#update-firstname').val(),
                    tele: $('#update-tele').val(),
                    datestudy: $('#update-datestudy').val(),
                    class: $('#update-class').val(),
                    teacher: $('#update-teacher').val(),
                };

                // Assuming an endpoint /updateStudent exists
                $.post('/updateStudent', studentData, function (response) {
                    alert(response.message || "Student updated successfully!");
                    loadAllStudents();
                    $('#editStudentModal').modal('hide'); // Hide modal on success
                }).fail(function () {
                    alert("Failed to update student.");
                });
            });

            // This part listens for requests from the class-manager page to show students
            // It seems to have been removed, let's add it back in a more robust way.
            // Note: This approach is unconventional. A better long-term solution would be
            // to have a dedicated student list page or handle this within class-manager.html itself.
            // However, to fix the existing logic:
            const urlParams = new URLSearchParams(window.location.search);
            const classCodeToView = urlParams.get('view_class');

            if (classCodeToView) {
                // Wait for all students to be loaded
                const interval = setInterval(function () {
                    if (all_students.length > 0) {
                        clearInterval(interval);
                        const filtered = all_students.filter(s => s.class === classCodeToView);
                        displayStudentsInTable(filtered);
                        // Optionally, update a title or breadcrumb
                        const listHeader = $('.card-header h5');
                        if (listHeader.length) {
                            listHeader.text(`Students in Class: ${classCodeToView}`);
                        }
                        $('#pagination').hide(); // Hide pagination for this filtered view
                    }
                }, 100);
            }
        })

        function displayStudentsInTable(students) {
            $('tbody').empty();
            students.forEach(student => {
                $('tbody').append(`<tr class="${student.id}">
                            <td scope="col">${student.id}</td>
                            <td scope="col">${student.LastName}</td>
                            <td scope="col">${student.FirstName}</td>
                            <td scope="col">${student.tel}</td>
                            <td scope="col">${student.dateStudy.slice(0, 10)}</td>
                            <td scope="col">${student.class}</td>
                            <td><button class="btn btn-sm btn-danger delete">Delete</button></td>
                        </tr>`);
            });
        }

        const loadPage = (page = 1, limit = 10) => {
            $.get('/getData', { page, limit }, function (data) {
                displayStudentsInTable(data.students);

                $('#pagination').empty();

                if (data.totalPages > 1) {
                    if (page > 1) {
                        $('#pagination').append(`<li class="page-item"><a class="page-link" href="#" onclick="loadPage(${page - 1}, ${limit})">Previous</a></li>`);
                    } else {
                        $('#pagination').append('<li class="page-item disabled"><span class="page-link">Previous</span></li>');
                    }

                    for (let i = 1; i <= data.totalPages; i++) {
                        $('#pagination').append(`<li class="page-item ${i === page ? 'active' : ''}"><a class="page-link" href="#" onclick="loadPage(${i}, ${limit})">${i}</a></li>`);
                    }

                    if (page < data.totalPages) {
                        $('#pagination').append(`<li class="page-item"><a class="page-link" href="#" onclick="loadPage(${page + 1}, ${limit})">Next</a></li>`);
                    } else {
                        $('#pagination').append('<li class="page-item disabled"><span class="page-link">Next</span></li>');
                    }
                }
            });
        };



    </script>
</body>

</html>